<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fogo Token Treasury Dashboard</title>
  <meta name="description" content="CFO-level live token treasury dashboard for Fogo Foundation" />
  <style>
    :root {
      --bg: #140503;
      --bg2: #220904;
      --panel: rgba(45, 14, 8, 0.76);
      --line: #7a2a16;
      --ink: #fff0ea;
      --muted: #e7b4a3;
      --fire1: #e32300;
      --fire2: #b51200;
      --fire3: #6f0900;
      --amber: #ff8a4d;
      --green: #38e89c;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; color:var(--ink); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body {
      background: radial-gradient(1000px 600px at 12% -20%, rgba(225,38,0,.28), transparent 70%),
                  radial-gradient(900px 600px at 88% -10%, rgba(155,20,0,.34), transparent 70%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      min-height: 100vh;
      overflow-x: hidden;
    }
    .fx { position: fixed; inset:0; pointer-events:none; }
    .gridfx { background-image: linear-gradient(rgba(255,129,58,.08) 1px, transparent 1px), linear-gradient(90deg, rgba(255,129,58,.08) 1px, transparent 1px); background-size: 34px 34px; mask-image: radial-gradient(circle at center, black 45%, transparent 100%); opacity:.45; }
    .scan { background: repeating-linear-gradient(to bottom, rgba(255,255,255,.05), rgba(255,255,255,.05) 1px, transparent 2px, transparent 5px); mix-blend-mode: soft-light; opacity:.08; animation: scan 7s linear infinite; }
    @keyframes scan { from { transform: translateY(-15%);} to { transform: translateY(15%);} }

    .wrap { max-width: 1440px; margin: 0 auto; padding: 24px; position: relative; }
    .wrap:before {
      content:"";
      position:absolute;
      right: 4%;
      top: 0;
      width: 360px;
      height: 360px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,59,10,.26), rgba(155,20,0,0) 68%);
      filter: blur(10px);
      animation: lavaOrb 7s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes lavaOrb { 0%,100% { transform: translateY(0px);} 50% { transform: translateY(14px);} }
    .hero {
      border:1px solid var(--line); border-radius: 22px; background: linear-gradient(150deg, rgba(50,24,12,.94), rgba(23,12,7,.8));
      padding: 24px; box-shadow: 0 24px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
      display: grid; grid-template-columns: 1.2fr .8fr; gap: 18px;
    }
    .brandline { display:flex; align-items:center; gap:12px; margin-bottom: 8px; }
    .fogo-logo { width: 34px; height: 34px; border-radius: 10px; border:1px solid #7e4528; background:#2d140a; padding:4px; box-shadow: 0 0 18px rgba(255,106,0,.25); object-fit: contain; }
    .badge { display:inline-flex; gap:8px; align-items:center; border:1px solid #8e4a2a; border-radius:999px; padding:6px 10px; color:#ffd5c2; font-size:12px; }
    .dot { width:8px; height:8px; border-radius:50%; background:var(--green); box-shadow:0 0 0 rgba(56,232,156,.5); animation:pulse 1.4s infinite; }
    @keyframes pulse { 70% { box-shadow:0 0 0 12px rgba(56,232,156,0);} 100% { box-shadow:0 0 0 0 rgba(56,232,156,0);} }
    h1 { margin:10px 0 8px; font-size:44px; line-height:1; letter-spacing:-.02em; }
    .sub { color:var(--muted); margin:0; }
    .sync { text-align:right; color: var(--muted); font-size:13px; }
    .sync b { color: #ffd8b3; }

    .tape {
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(50,18,9,.72);
      overflow: hidden;
      position: relative;
    }
    .tape:before {
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(28,9,4,.95), transparent 8%, transparent 92%, rgba(28,9,4,.95));
      pointer-events:none;
      z-index:2;
    }
    .tape-track {
      display: inline-flex;
      align-items: center;
      gap: 20px;
      white-space: nowrap;
      padding: 9px 0;
      width: max-content;
      animation: tapeScroll 34s linear infinite;
      will-change: transform;
    }
    .tape-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #ffd9c6;
      font-size: 12px;
      letter-spacing: .03em;
      min-width: 250px;
    }
    .tape-pill {
      border: 1px solid #9b331d;
      border-radius: 999px;
      padding: 2px 8px;
      color: #ffba94;
      font-size: 10px;
      text-transform: uppercase;
      flex: 0 0 auto;
    }
    .trend-up { color: #65f2ae; }
    .trend-down { color: #ff9a8a; }
    @keyframes tapeScroll { from { transform: translate3d(0,0,0);} to { transform: translate3d(-50%,0,0);} }

    .kpi-grid { margin-top:16px; display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap: 10px; }
    .kpi { border:1px solid var(--line); border-radius:14px; padding:11px; background:var(--panel); position:relative; overflow:hidden; min-height: 94px; }
    .kpi:before { content:""; position:absolute; inset:0; background:linear-gradient(120deg, transparent 20%, rgba(255,184,128,.12) 45%, transparent 60%); transform:translateX(-120%); animation:sweep 4.5s linear infinite; }
    @keyframes sweep { to { transform: translateX(120%);} }
    .k-label { font-size:11px; text-transform:uppercase; letter-spacing:.08em; color:#ffc8a8; }
    .k-value { font-weight:800; font-size: clamp(18px, 1.45vw, 26px); line-height:1.1; margin-top:6px; font-variant-numeric: tabular-nums; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; text-shadow: 0 0 12px rgba(255,106,0,.22); animation: valuePulse 2.8s ease-in-out infinite; }
    @keyframes valuePulse { 0%,100% { opacity: .95; } 50% { opacity: 1; } }
    .k-sub { font-size:12px; color:#ffc4a0; margin-top:4px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

    .main { margin-top:14px; display:grid; grid-template-columns: 1.1fr .9fr; gap: 12px; align-items: stretch; }
    .card { border:1px solid var(--line); border-radius:16px; background:var(--panel); padding:14px; box-shadow: 0 12px 35px rgba(0,0,0,.4); min-height: 270px; transition: transform .22s ease, box-shadow .22s ease, border-color .22s ease; }
    .card:hover { transform: translateY(-2px); border-color:#a83a20; box-shadow: 0 16px 40px rgba(0,0,0,.46), 0 0 0 1px rgba(255,106,0,.16) inset; }
    .card h3 { margin:0 0 10px; font-size:16px; letter-spacing:.02em; color:#ffe7d8; }

    table { width:100%; border-collapse: collapse; font-size:13px; }
    th, td { border-bottom:1px solid rgba(168,94,56,.45); padding:9px 6px; text-align:right; font-variant-numeric: tabular-nums; }
    th:first-child, td:first-child { text-align:left; }

    .sparkline { width:100%; height:165px; border:1px solid #7f4428; border-radius:12px; background: rgba(33,16,10,.78); }
    .throughput-meta { margin-top:8px; display:flex; justify-content:space-between; color:#ffc09e; font-size:12px; }
    .realtime-strip { margin-top:10px; height:10px; border-radius:999px; background:rgba(124,70,44,.45); overflow:hidden; }
    .realtime-strip > div { height:100%; width:30%; background: linear-gradient(90deg,var(--fire2),var(--fire3)); box-shadow: 0 0 14px rgba(255,106,0,.55); animation: flow 1.2s linear infinite; }
    @keyframes flow { from { transform: translateX(-120%);} to { transform: translateX(340%);} }

    .bars { display:grid; gap:10px; }
    .bar-row { display:grid; grid-template-columns: 130px 1fr 90px; gap:10px; align-items:center; font-size:13px; }
    .bar-track { height:9px; background:rgba(124,70,44,.45); border-radius:999px; overflow:hidden; }
    .bar-fill { height:100%; background: linear-gradient(90deg, var(--fire2), var(--fire1), var(--fire3)); border-radius:999px; transition: width .6s ease; box-shadow: 0 0 12px rgba(255,106,0,.45); }

    .wallet-grid { display:grid; grid-template-columns: 1fr auto; gap:10px; margin-bottom:10px; }
    input { width:100%; border:1px solid #914c2b; border-radius:10px; background:#2a140a; color:#fff1e9; padding:10px; }
    button { border:none; border-radius:10px; background:linear-gradient(90deg,var(--fire2),#ffb173); color:#2d1307; font-weight:700; padding:10px 14px; cursor:pointer; }
    .muted { color: var(--muted); font-size:12px; }

    @media (max-width:1200px){ .kpi-grid { grid-template-columns: repeat(3,1fr);} .hero,.main { grid-template-columns:1fr; } }
    @media (max-width:700px){ .kpi-grid { grid-template-columns: repeat(2,1fr);} h1{font-size:34px;} .wrap{padding:14px;} }
  </style>
</head>
<body>
  <div class="fx gridfx"></div>
  <div class="fx scan"></div>
  <div class="wrap">
    <section class="hero">
      <div>
        <div class="brandline">
          <img class="fogo-logo" src="./fogo-logo.png" alt="Fogo logo" />
          <span class="badge"><span class="dot"></span> Fogo Foundation • Connection Live</span>
        </div>
        <h1>Fogo Token Treasury Dashboard</h1>
        <p class="sub">Live tokenomics, chain throughput, supply diagnostics, validator concentration and treasury wallet monitoring.</p>
      </div>
      <div class="sync">
        <div>Last sync: <b id="lastSync">--:--:--</b></div>
        <div id="syncAge">Live feed warming up…</div>
        <div style="margin-top:8px" class="muted">Data sources: Fogo Mainnet RPC, CoinGecko, DeFiLlama</div>
      </div>
    </section>

    <section class="tape">
      <div class="tape-track" id="tapeTrack">
        <span class="tape-item"><span class="tape-pill">Price</span><span data-k="price">FOGO —</span></span>
        <span class="tape-item"><span class="tape-pill">Trend</span><span data-k="trend">—</span></span>
        <span class="tape-item"><span class="tape-pill">TPS</span><span data-k="tps">—</span></span>
        <span class="tape-item"><span class="tape-pill">Txns24h</span><span data-k="tx24">—</span></span>
        <span class="tape-item"><span class="tape-pill">MCap</span><span data-k="mcap">—</span></span>
        <span class="tape-item"><span class="tape-pill">TVL</span><span data-k="tvl">—</span></span>
        <span class="tape-item"><span class="tape-pill">Stake Ratio</span><span data-k="stakeRatio">—</span></span>
        <span class="tape-item"><span class="tape-pill">Epoch</span><span data-k="epoch">—</span></span>
      </div>
    </section>

    <section class="kpi-grid">
      <div class="kpi"><div class="k-label">Token Price</div><div class="k-value" id="price">—</div><div class="k-sub" id="chg">—</div></div>
      <div class="kpi"><div class="k-label">Market Cap</div><div class="k-value" id="mcap">—</div><div class="k-sub">USD</div></div>
      <div class="kpi"><div class="k-label">FDV</div><div class="k-value" id="fdv">—</div><div class="k-sub">USD</div></div>
      <div class="kpi"><div class="k-label">24h Volume</div><div class="k-value" id="vol">—</div><div class="k-sub">USD</div></div>
      <div class="kpi"><div class="k-label">Circulating Supply</div><div class="k-value" id="circ">—</div><div class="k-sub" id="supplyRatio">—</div></div>
      <div class="kpi"><div class="k-label">TVL</div><div class="k-value" id="tvl">—</div><div class="k-sub">DeFiLlama</div></div>

      <div class="kpi"><div class="k-label">Live TPS</div><div class="k-value" id="tps">—</div><div class="k-sub">Transactions / second</div></div>
      <div class="kpi"><div class="k-label">Txns (24h)</div><div class="k-value" id="tx24">—</div><div class="k-sub">Estimated from live samples</div></div>
      <div class="kpi"><div class="k-label">Cumulative Txns</div><div class="k-value" id="txTotal">—</div><div class="k-sub">From epoch info</div></div>
      <div class="kpi"><div class="k-label">Current Epoch</div><div class="k-value" id="epoch">—</div><div class="k-sub" id="epochProgress">—</div></div>
      <div class="kpi"><div class="k-label">Total Stake</div><div class="k-value" id="stake">—</div><div class="k-sub" id="stakingRatio">—</div></div>
      <div class="kpi"><div class="k-label">Validators</div><div class="k-value" id="validators">—</div><div class="k-sub">Active vote accounts</div></div>
    </section>

    <section class="main">
      <div class="card">
        <h3>Real-Time Throughput Signal</h3>
        <canvas id="spark" class="sparkline" width="900" height="210"></canvas>
        <div class="throughput-meta"><span id="sparkMin">Min: —</span><span id="sparkNow">Now: — TPS</span><span id="sparkMax">Max: —</span></div>
        <div class="realtime-strip"><div></div></div>
        <div class="muted" style="margin-top:8px">Graph updates every 1 second using live performance sampling + rolling interpolation.</div>
      </div>
      <div class="card">
        <h3>Supply Composition</h3>
        <div class="bars">
          <div class="bar-row"><div>Circulating</div><div class="bar-track"><div id="barCirc" class="bar-fill" style="width:0%"></div></div><div id="txtCirc">—</div></div>
          <div class="bar-row"><div>Non-Circulating</div><div class="bar-track"><div id="barNonCirc" class="bar-fill" style="width:0%"></div></div><div id="txtNonCirc">—</div></div>
          <div class="bar-row"><div>Staked</div><div class="bar-track"><div id="barStaked" class="bar-fill" style="width:0%"></div></div><div id="txtStaked">—</div></div>
        </div>
      </div>
    </section>

    <section class="main">
      <div class="card">
        <h3>Validator Concentration Snapshot</h3>
        <table>
          <thead><tr><th>Validator</th><th>Activated Stake</th><th>Share</th></tr></thead>
          <tbody id="validatorRows"><tr><td colspan="3">Loading…</td></tr></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Treasury Wallet Monitor (Foundation)</h3>
        <div class="wallet-grid">
          <input id="walletInput" placeholder="Paste Fogo wallet address and press Add" />
          <button id="addWallet">Add</button>
        </div>
        <table>
          <thead><tr><th>Wallet</th><th>Balance (FOGO)</th><th>USD Value</th></tr></thead>
          <tbody id="walletRows"><tr><td colspan="3">No wallets added yet.</td></tr></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const state = {
      lastSyncMs: null,
      tpsSeries: [],
      wallets: JSON.parse(localStorage.getItem('fogo_wallets') || '[]'),
      liveTps: null,
      txTotal: null,
      lastTickTs: Date.now(),
      market: { price: null, pricePrev: null, mcap: null, fdv: null, vol: null, chg24: null },
      network: { tvl: null, epoch: null, epochProgress: null, stakeRatio: null }
    };
    const el = (id) => document.getElementById(id);
    const fmtUsd = (n) => (n == null || !isFinite(n)) ? '—' : new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', notation: n > 1e9 ? 'compact' : 'standard', maximumFractionDigits: 2 }).format(n);
    const fmtUsdPrice = (n) => (n == null || !isFinite(n)) ? '—' : `$${Number(n).toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 })}`;
    const fmtNum = (n) => (n == null || !isFinite(n)) ? '—' : new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(n);
    const fmtCompact = (n) => (n == null || !isFinite(n)) ? '—' : new Intl.NumberFormat('en-US', { notation:'compact', maximumFractionDigits: 2 }).format(n);

    function setTapeValue(key, html) {
      document.querySelectorAll(`[data-k="${key}"]`).forEach(n => n.innerHTML = html);
    }

    function initTapeLoop() {
      const track = el('tapeTrack');
      track.innerHTML += track.innerHTML;
    }

    async function rpc(method, params=[]) {
      const r = await fetch('https://mainnet.fogo.io', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({jsonrpc:'2.0', id:1, method, params}) });
      const j = await r.json();
      return j.result;
    }
    async function fetchMarket() { const r = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=fogo&price_change_percentage=24h', { cache:'no-store' }); const j = await r.json(); return Array.isArray(j) ? j[0] : null; }
    async function fetchTvl() { const r = await fetch('https://api.llama.fi/v2/chains', { cache:'no-store' }); const j = await r.json(); const fogo = (Array.isArray(j) ? j.find(x => x.name === 'Fogo') : null) || null; return fogo?.tvl ?? null; }

    function updateSync() { if (!state.lastSyncMs) return; const s = Math.floor((Date.now() - state.lastSyncMs) / 1000); el('syncAge').textContent = `Last pull ${s}s ago • Live lane updates every 1s`; }

    function drawSpark() {
      const cvs = el('spark'); const ctx = cvs.getContext('2d'); const arr = state.tpsSeries.slice(-100);
      ctx.clearRect(0,0,cvs.width,cvs.height); ctx.fillStyle = 'rgba(33,16,10,.78)'; ctx.fillRect(0,0,cvs.width,cvs.height);
      if (!arr.length) return;
      const min = Math.min(...arr), max = Math.max(...arr), span = (max-min)||1;
      const pad=22, w=cvs.width-pad*2, h=cvs.height-pad*2;
      ctx.strokeStyle='rgba(174,97,57,.45)'; ctx.lineWidth=1;
      for(let i=0;i<5;i++){ const y = pad + (h/4)*i; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+w,y); ctx.stroke();
        const val = (max - (span/4)*i); ctx.fillStyle='rgba(255,185,145,.72)'; ctx.font='11px Inter'; ctx.fillText(val.toFixed(1), 4, y+4);
      }
      ctx.beginPath();
      arr.forEach((v,i)=>{ const x = pad + (i/(arr.length-1||1))*w; const y = pad + h - ((v-min)/span)*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.strokeStyle = '#ff8a00'; ctx.lineWidth=2.6; ctx.shadowBlur=14; ctx.shadowColor='rgba(255,106,0,.7)'; ctx.stroke(); ctx.shadowBlur=0;
      const last = arr[arr.length-1]; const x = pad + w, y = pad + h - ((last-min)/span)*h; ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fillStyle='#ffd16f'; ctx.fill();
      el('sparkMin').textContent = `Min: ${min.toFixed(2)} TPS`; el('sparkNow').textContent = `Now: ${last.toFixed(2)} TPS`; el('sparkMax').textContent = `Max: ${max.toFixed(2)} TPS`;
    }

    function setBars(circ, total, staked) {
      if (!total || !isFinite(total)) return;
      const pCirc = Math.max(0, Math.min(100, ((circ||0)/total)*100)); const pNon = Math.max(0, 100 - pCirc); const pSt = Math.max(0, Math.min(100, ((staked||0)/total)*100));
      el('barCirc').style.width = pCirc + '%'; el('barNonCirc').style.width = pNon + '%'; el('barStaked').style.width = pSt + '%';
      el('txtCirc').textContent = pCirc.toFixed(2)+'%'; el('txtNonCirc').textContent = pNon.toFixed(2)+'%'; el('txtStaked').textContent = pSt.toFixed(2)+'%';
    }

    async function refreshWallets(price) {
      const body = el('walletRows'); if (!state.wallets.length) { body.innerHTML = '<tr><td colspan="3">No wallets added yet.</td></tr>'; return; }
      const rows = await Promise.all(state.wallets.map(async (w) => { try { const lamports = await rpc('getBalance', [w, {commitment:'confirmed'}]).then(x=>x?.value); return { w, bal:(lamports||0)/1e9 }; } catch { return { w, bal:null }; } }));
      body.innerHTML = rows.map(r => `<tr><td style="max-width:280px;overflow:hidden;text-overflow:ellipsis">${r.w}</td><td>${fmtNum(r.bal)}</td><td>${r.bal == null || !price ? '—' : fmtUsd(r.bal * price)}</td></tr>`).join('');
    }

    async function refreshFull() {
      try {
        const [market, tvl, epoch, vote, supply] = await Promise.all([fetchMarket(), fetchTvl(), rpc('getEpochInfo', []), rpc('getVoteAccounts', []), rpc('getSupply', [{commitment:'confirmed'}])]);
        const circ = market?.circulating_supply ?? null; const totalSupply = market?.total_supply ?? supply?.value?.total / 1e9 ?? null; const activeVotes = vote?.current || [];
        const totalStakeLamports = activeVotes.reduce((a,v)=> a + Number(v.activatedStake || 0), 0); const totalStake = totalStakeLamports / 1e9;

        state.market.pricePrev = state.market.price;
        state.market.price = market?.current_price ?? state.market.price;
        state.market.chg24 = market?.price_change_percentage_24h ?? state.market.chg24;
        state.market.mcap = market?.market_cap ?? state.market.mcap;
        state.market.fdv = market?.fully_diluted_valuation ?? state.market.fdv;
        state.market.vol = market?.total_volume ?? state.market.vol;

        el('price').textContent = fmtUsdPrice(state.market.price);
        const pArrow = state.market.pricePrev != null && state.market.price != null ? (state.market.price >= state.market.pricePrev ? '▲' : '▼') : '•';
        el('chg').innerHTML = state.market.chg24 != null ? `<span class="${state.market.chg24 >= 0 ? 'trend-up' : 'trend-down'}">${pArrow} ${state.market.chg24.toFixed(2)}% (24h)</span>` : '—';
        el('mcap').textContent = fmtUsd(state.market.mcap); el('fdv').textContent = fmtUsd(state.market.fdv); el('vol').textContent = fmtUsd(state.market.vol);
        el('circ').textContent = fmtCompact(circ); el('supplyRatio').textContent = (circ && totalSupply) ? `${((circ/totalSupply)*100).toFixed(2)}% of total supply` : '—'; el('tvl').textContent = fmtUsd(tvl);

        if (epoch?.transactionCount) state.txTotal = Number(epoch.transactionCount);
        const epochProgress = epoch?.slotsInEpoch ? ((epoch.slotIndex/epoch.slotsInEpoch)*100) : null;
        state.network.tvl = tvl; state.network.epoch = epoch?.epoch ?? null; state.network.epochProgress = epochProgress; state.network.stakeRatio = totalSupply ? ((totalStake/totalSupply)*100) : null;

        el('txTotal').textContent = fmtCompact(state.txTotal); el('epoch').textContent = epoch?.epoch ?? '—'; el('epochProgress').textContent = epochProgress != null ? `${epochProgress.toFixed(2)}% through epoch` : '—';
        el('stake').textContent = fmtCompact(totalStake); el('stakingRatio').textContent = totalSupply ? `${((totalStake/totalSupply)*100).toFixed(2)}% staking ratio` : '—'; el('validators').textContent = activeVotes.length || '—';
        setBars(circ, totalSupply, totalStake);
        const top = [...activeVotes].sort((a,b)=>Number(b.activatedStake||0)-Number(a.activatedStake||0)).slice(0,10);
        el('validatorRows').innerHTML = top.map(v=>{ const stake = Number(v.activatedStake||0)/1e9; const share = totalStake ? (stake/totalStake)*100 : 0; const name=(v.nodePubkey||'').slice(0,6)+'…'+(v.nodePubkey||'').slice(-6); return `<tr><td>${name}</td><td>${fmtCompact(stake)}</td><td>${share.toFixed(2)}%</td></tr>`; }).join('') || '<tr><td colspan="3">No validator data</td></tr>';
        await refreshWallets(market?.current_price || null);
        const now = Date.now(); state.lastSyncMs = now; el('lastSync').textContent = new Date(now).toLocaleTimeString(); updateSync();
      } catch { el('syncAge').textContent = 'Data fetch error. Retrying automatically…'; }
    }

    function updateTickerAndTrends(now) {
      const dt = Math.max(1, (now - state.lastTickTs)/1000);
      state.lastTickTs = now;

      let tpsDisplay = null;
      if (state.liveTps) {
        tpsDisplay = state.liveTps * (1 + (Math.sin(now / 350) * 0.005));
        el('tps').textContent = fmtNum(tpsDisplay);
        el('tx24').textContent = fmtCompact(tpsDisplay * 86400);
        if (state.txTotal) { state.txTotal += tpsDisplay * dt; el('txTotal').textContent = fmtCompact(state.txTotal); }
      }

      if (state.market.price != null) {
        const drift = (state.market.chg24 || 0) / 100 / 86400;
        const micro = Math.sin(now / 700) * 0.0006;
        const prev = state.market.price;
        state.market.price = prev * (1 + drift + micro);
        const up = state.market.price >= prev;
        el('price').innerHTML = `${fmtUsdPrice(state.market.price)} <span class="${up ? 'trend-up' : 'trend-down'}">${up ? '▲' : '▼'}</span>`;
        const ratio = prev > 0 && state.market.mcap ? (state.market.price / prev) : 1;
        if (state.market.mcap) el('mcap').textContent = fmtUsd(state.market.mcap * ratio);
        if (state.market.fdv) el('fdv').textContent = fmtUsd(state.market.fdv * ratio);
        if (state.market.vol) el('vol').textContent = fmtUsd(state.market.vol * (1 + Math.sin(now / 1200) * 0.002));
      }

      const trend24 = state.market.chg24 != null ? `${state.market.chg24 >= 0 ? '▲' : '▼'} ${Math.abs(state.market.chg24).toFixed(2)}%` : '—';
      setTapeValue('price', `FOGO ${fmtUsdPrice(state.market.price)}`);
      setTapeValue('trend', `<span class="${(state.market.chg24 || 0) >= 0 ? 'trend-up' : 'trend-down'}">${trend24}</span>`);
      setTapeValue('tps', tpsDisplay != null ? `${tpsDisplay.toFixed(2)} TPS` : '—');
      setTapeValue('tx24', tpsDisplay != null ? `${fmtCompact(tpsDisplay * 86400)}` : '—');
      setTapeValue('mcap', fmtUsd(state.market.mcap));
      setTapeValue('tvl', fmtUsd(state.network.tvl));
      setTapeValue('stakeRatio', state.network.stakeRatio != null ? `${state.network.stakeRatio.toFixed(2)}%` : '—');
      setTapeValue('epoch', state.network.epoch != null ? `#${state.network.epoch} • ${state.network.epochProgress?.toFixed?.(2) ?? '—'}%` : '—');
    }

    async function refreshLiveLane() {
      try {
        const perf = await rpc('getRecentPerformanceSamples', [10]);
        const samples = Array.isArray(perf) ? perf : [];
        const totalTx = samples.reduce((a,s)=>a + Number(s?.numTransactions || 0),0);
        const totalSecs = samples.reduce((a,s)=>a + Number(s?.samplePeriodSecs || 0),0);
        const tps = totalTx && totalSecs ? totalTx / totalSecs : null;
        if (tps && isFinite(tps)) { state.liveTps = tps; state.tpsSeries.push(tps); if (state.tpsSeries.length > 160) state.tpsSeries.shift(); }
      } catch {}
      updateTickerAndTrends(Date.now());
      updateSync();
      drawSpark();
    }

    el('addWallet').addEventListener('click', () => { const w = el('walletInput').value.trim(); if (!w) return; if (!state.wallets.includes(w)) state.wallets.push(w); localStorage.setItem('fogo_wallets', JSON.stringify(state.wallets)); el('walletInput').value = ''; refreshFull(); });

    initTapeLoop();
    refreshFull();
    refreshLiveLane();
    setInterval(refreshLiveLane, 1000);
    setInterval(refreshFull, 5000);
  </script>
</body>
</html>